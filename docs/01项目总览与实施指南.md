# piapi 项目总览与实施指南

本文整合原先分散的规格、路由、管理后台与策略增强文档，面向开发与运维团队提供统一的产品定位、架构说明与实施指引。

## 1. 项目概览

### 1.1 使命

`piapi` 是面向小型开发团队的配置驱动型 LLM 编码助手网关，通过统一的 `/piapi/<service_type>` 接口屏蔽上游差异，帮助团队快速接入多家供应商并精细化控制用户路由。

### 1.2 核心特性

- **统一入口**：请求路径稳定，调用方无需关注供应商差异。
- **用户-服务粒度路由**：同一用户可针对不同 `service_type` 绑定独立上游。
- **聚合候选与多策略调度**：支持 `round_robin`、`weighted_rr`、`adaptive_rr`、`sticky_healthy` 等策略。
- **命名密钥管理**：API Key 通过名称引用，便于轮换与审计。
- **配置即代码**：单一 `config.yaml` 驱动全部路由信息，支持版本管理。
- **热加载与回退**：配置文件变更即刻生效，失败时保留旧配置并记录指标。
- **可观测性**：Zap 结构化日志、Prometheus 指标与管理后台观测面板协同排障。
- **嵌入式管理后台**：启用 `PIAPI_ADMIN_TOKEN` 后可在 `/piadmin` 执行配置维护与运行态观测。

## 2. 配置模型与路由策略

### 2.1 `config.yaml` 结构

```yaml
providers:
  - name: provider-alpha
    apiKeys:
      main-key: sk-alpha-xxx
      backup-key: sk-alpha-backup
    services:
      - type: codex
        baseUrl: https://api.provider-alpha.com/v1/engines
        auth:
          mode: header
          name: Authorization
          prefix: "Bearer "
      - type: claude_code
        baseUrl: https://api.provider-alpha.com/v1/claude
        auth:
          mode: header
          name: x-api-key
  - name: provider-beta
    apiKeys:
      prod-key: sk-beta-yyy
    services:
      - type: codex
        baseUrl: https://api.provider-beta.com/codex
        auth:
          mode: query
          name: api_key

users:
  - name: Alice
    apiKey: piapi-user-alice
    services:
      codex:
        strategy: adaptive_rr
        candidates:
          - providerName: provider-alpha
            providerKeyName: main-key
            weight: 3
            enabled: true
          - providerName: provider-beta
            providerKeyName: prod-key
            weight: 1
            enabled: true
      claude_code:
        providerName: provider-alpha
        providerKeyName: main-key
  - name: Bob
    apiKey: piapi-user-bob
    services:
      codex:
        providerName: provider-alpha
        providerKeyName: backup-key
```

#### 说明

- `providers[].services[].auth` 支持 `header` 与 `query` 两种模式；未声明时默认使用 `Authorization: Bearer <key>`。
- `users[].services` 支持传统单路由（`providerName` + `providerKeyName`）与聚合路由（`strategy` + `candidates`）。候选可配置 `weight`、`enabled`、`tags`。
- 请求路径 `/piapi/<service_type>/<rest>` 会将 `<rest>` 追加到上游 `baseUrl` 后，支持透传流式响应。

### 2.2 策略行为

| 策略 | 行为 | 适用场景 |
| ---- | ---- | -------- |
| `round_robin` | 在健康候选之间轮流命中 | 默认均衡分流 |
| `weighted_rr` | 按静态权重分配请求 | 手动设定优先级 |
| `adaptive_rr` | 静态权重 × 质量因子，基于指数滑动窗口抑制高错误率候选 | 自动压制不稳定上游 |
| `sticky_healthy` | 粘住最近成功的候选，失败后切换 | 追求稳定体验、优先最佳候选 |

`adaptive_rr` 可通过环境变量微调：  
`PIAPI_ADAPTIVE_HALFLIFE`（默认 `1m`）控制半衰期，`PIAPI_ADAPTIVE_QUALITY_FLOOR`（默认 `0.1`）控制质量下限。

### 2.3 运行时观察

- `internal/config.Manager.RuntimeStatus` 暴露候选 `healthy`、`unhealthy_until`、`total_requests`、`total_errors`、`smoothed_error_rate`、`effective_weight` 等指标。
- 管理后台 `/piadmin/api/stats/routes` 与 Observability 页面展示上述数据，便于排障与调参。

## 3. 系统架构

```
cmd/piapi                # 入口，解析参数并初始化依赖
internal/config          # 配置解析、热加载、策略调度
internal/server          # HTTP 网关、RequestID 中间件、ReverseProxy
internal/adminapi        # 管理 API：配置读写、运行态统计、日志查询
internal/adminui         # 嵌入式静态资源与 SPA 路由
internal/logging         # Zap JSON 日志与请求日志环形缓冲
internal/metrics         # Prometheus 指标注册与采集
web/admin                # Next.js 前端源代码
```

### 3.1 网关工作流

1. 客户端以 `Authorization: Bearer <user_api_key>` 调用 `/piapi/<service_type>/...`。
2. `Gateway` 解析服务类型，调用 `config.Manager.Resolve` 获取路由。
3. `httputil.ReverseProxy` 改写目标 URL，注入上游认证信息并转发请求。
4. 记录 Prometheus 指标与结构化日志，同时写入 `GlobalRequestLogStore`。
5. `ReportResult` 回写候选健康状态，驱动后续调度。

### 3.2 管理后台组件

- **管理 API**：`/piadmin/api/*`，通过 `Authorization: Bearer <PIAPI_ADMIN_TOKEN>` 鉴权，提供配置读取、写入、候选统计与日志查询。写入流程包含：备份原文件 → 写入新内容 → 重新加载 → 失败回滚。
- **前端 UI**：Next.js + React + SWR，生产模式静态导出后嵌入 Go 二进制。默认 BasePath `/piadmin`，开发态可通过 `PIAPI_DEV_PROXY` 连接远端后端。
- **功能分区**：登录、Providers、Users、Observability；Users 支持候选编辑、权重/启停调整，并实时展示运行态指标。

## 4. 管理后台实施指导

### 4.1 技术定位

- 内部低频管理工具，以安全可靠、易维护为优先。
- 技术栈可根据团队熟悉度调整（当前为 Next.js 16 / React 19，后续可按规划降级至稳定版本或替换为更轻量方案）。
- UI 设计稿仅作交互参考，开发团队可自主决定实现细节。

### 4.2 开发工作流

| 操作 | 命令 | 说明 |
| ---- | ---- | ---- |
| 后端热重载 | `make dev-backend` | 使用 Air，默认读取/生成 `config.dev.yaml`，`PIAPI_ADMIN_TOKEN=piapi` |
| 前端开发 | `make dev-frontend` | 在 `web/admin` 下运行 `pnpm dev`，自动代理 `/piadmin/api` |
| 前端构建 | `make admin-build` | 安装依赖并导出静态资源到 `internal/adminui/dist` |
| 一体化构建 | `make build` | 构建前端 + Go 二进制 |
| Docker 构建 | `make docker-build` | Node + Go 多阶段，最终 distroless 镜像 |

启用管理后台需设置 `PIAPI_ADMIN_TOKEN`，生产环境建议结合防火墙/IP 白名单进一步保护。

### 4.3 MVP 验收要点

1. **后端 API**：配置读写、安全认证、热加载、失败回滚。
2. **前端对接**：移除假数据，统一通过 `lib/api.ts` 访问后端并处理加载/错误状态。
3. **部署流程**：Makefile + Dockerfile 支撑一体化构建，二进制自带静态资源。
4. **观测能力**：Users & Observability 页面展示候选健康、错误率、有效权重等指标。

## 5. 实施与运维

- **配置变更**：通过 Admin UI 或直接编辑 `config.yaml`。建议使用 Git 版本管理，并在修改后观察 `piapi_config_reloads_total` 指标。
- **日志**：基础请求日志输出到 stdout；调用 `/piadmin/api/dashboard/logs` 可获取内存中的最近记录（容量由 `PIAPI_LOG_CAPACITY` 控制）。
- **监控**：`/metrics` 提供请求量、延迟、配置重载、候选级指标；可根据需要启用 `EnableCandidateKeyLabels` 以输出 Key 维度数据。
- **权限要求**：Docker 容器以 UID 65532 运行，使用 bind mount 时需确保配置文件拥有读写权限。

## 6. 路由策略增强路线

重复现有策略的同时，持续演进以提升质量控制：

1. **Phase 1 - 后端扩展**  
   - 完成 `adaptive_rr`、`sticky_healthy` 逻辑与单元测试。  
   - 指标中暴露指数滑动窗口数据与粘性状态。
2. **Phase 2 - 管理后台支持**  
   - 表单新增策略选项与文案，Users 页面展示质量因子、最后命中时间等指标。  
   - 如需新增 API，请同步更新 `lib/api.ts` 与相关 UI。
3. **Phase 3 - 文档与运维**  
   - 更新 `config.yaml.example`、README 以及 Observability 指南。  
   - 提供启用/回滚说明与参数调优建议。

**风险与缓解**：
- 参数设定不当引起振荡 → 提供环境变量调节，同时在指标中暴露质量因子以便观察。
- 冷启动导致流量不足 → 设置保守的初始错误率，确保新候选有机会获取请求。
- 状态增长 → 运行时仅存储必要的累积值，随配置重载清理。

## 7. 验收清单

- `go test ./...`、前端构建或 lint 均通过。
- 管理后台可完成登录、配置读写、候选调整与指标查看。
- Prometheus 指标与日志记录覆盖核心链路。
- 文档、示例配置与 README 与实现保持一致。

## 8. 相关文档

- `docs/contributing.md`：贡献者指南与常用命令。
- `docs/changelog/2025-11-03.md`：近期生产修复与部署记录。
- `docs/archive/`：历史方案与会议纪要（含原始五份拆分文档）。
