# 路由策略增强实施方案

## 1. 背景

现有 `piapi` 路由支持 `round_robin` 与 `weighted_rr` 两种策略，权重完全依赖静态配置。运行时虽已经统计每个候选的请求数、错误数以及健康窗口，却尚未被用于调度决策。此外，一些用户希望在单个上游表现稳定时持续命中该节点，仅在节点退化时才自动切换，以实现“质量优先”的体验。

## 2. 目标

1. 新增“质量加权”策略（暂定枚举值 `adaptive_rr`），根据运行期统计对静态权重进行动态修正，自动抑制高错误率候选的流量占比。
2. 新增“粘性健康”策略（枚举值 `sticky_healthy`），在同一候选持续健康时保持命中，失败后才切换到下一可用候选。
3. 覆盖服务端（配置解析、路由选择、运行时统计）、管理后台（策略选项、指标展示）、以及文档示例，确保端到端可观测、可配置。

## 3. 策略设计概述

### 3.1 adaptive_rr（质量加权）

- **权重计算**：  
  基础权重 = 配置权重；质量因子 = `max(quality_floor, 1 - smoothed_error_rate)`；  
  其中 `smoothed_error_rate` 使用指数滑动窗口（默认 1 分钟半衰期）统计，`quality_floor` 防止候选被饿死（默认 0.1）。
- **调度逻辑**：  
  `selectCandidate` 在进入 weighted 分支时，先按上述规则计算临时权重，再执行与现有 weighted_rr 类似的取模算法。
- **运行期参数**：  
  半衰期、质量下限、初始权重衰减系数暴露为配置（`config.yaml` 可选字段或环境变量），默认值保证无需额外调整即可使用。

### 3.2 sticky_healthy（粘性健康）

- **状态记录**：  
  在 `resolvedUserService` 中维护 `lastHealthyIndex`。成功请求后更新该索引；若索引对应候选被禁用或仍在 `unhealthyUntil` 期，则回退到顺序扫描。
- **调度逻辑**：  
  `selectCandidate` 先尝试返回 `lastHealthyIndex` 指向的候选；不可用时按候选列表顺序查找下一可用项并更新索引。
- **恢复行为**：  
  一旦原候选重新健康，首次命中后又会继续“粘住”，无需额外逻辑。

## 4. 实施步骤

| 阶段 | 主要内容 | 输出 |
| --- | --- | --- |
| Phase 1 | 后端策略扩展 | <ul><li>更新 `internal/config/types.go` 添加策略枚举常量说明</li><li>在 `internal/config/manager.go` 解析校验新策略，并实现 `adaptive_rr` / `sticky_healthy` 调度逻辑</li><li>扩展运行时统计结构，新增指数滑动窗口、质量系数缓存</li><li>为新策略补充单元测试、集成测试（含边界与回退场景）</li></ul> |
| Phase 2 | 管理后台支持 | <ul><li>在 `web/admin/hooks/use-routing-strategies.ts`、表单组件中新增策略选项与描述</li><li>`UsersTable`、`ServiceRouteCard` UI 引入策略说明与实时质量指标展示（如质量因子、最后命中时间）</li><li>必要时新增 API 端点以提供质量因子/粘性状态观测</li></ul> |
| Phase 3 | 文档与运维 | <ul><li>更新 `config.yaml.example` 与 README 策略说明</li><li>在 `Observability` 页面补充质量因子解释、故障切换提示</li><li>完善部署与回滚指南（如何关闭新策略、重置权重窗口）</li></ul> |

## 5. 风险与缓解

- **算法参数不当**：质量因子衰减过快或过慢会导致策略振荡。→ 选择合理默认值，同时允许通过环境变量调整；添加 Prometheus 指标观察质量因子。
- **冷启动饿死**：刚上线的候选若缺乏请求可能被视为高错误率。→ 初始误差率采用保守假设（例如 0.05），确保有流量验证其真实表现。
- **状态膨胀**：指数滑动窗口需要额外状态存储。→ 使用轻量级结构（每候选仅存最近时间戳与累计衰减值），并在管理器替换时清理。

## 6. 验收标准

1. `go test ./...` 与前端 lint 均通过；新增单元测试覆盖主要算法路径（成功/失败/恢复）。
2. 管理后台可成功选择并保存新策略，路由在运行时按照预期行为切换，可通过 Observability 页面验证。
3. 文档与示例配置覆盖新策略，运维人员可按说明启用、停用或调整参数。
