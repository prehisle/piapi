# 用户-服务粒度路由说明

本文件总结 `piapi` 网关在用户-服务层面的路由模型，以及聚合候选与多策略调度的使用方式，供日常配置与排障参考。

## 1. 路由模型概览

- 每个用户通过唯一的 `apiKey` 识别。
- `users[].services` 是一个以 **服务类型** 为键的映射，值可以是：
  - 传统单路由：`providerName` + `providerKeyName`；
  - 聚合路由：`strategy` + `candidates[]`。
- 运行时根据请求路径 `/piapi/<service_type>` 解析服务类型，并在用户映射中找到对应配置；未配置的服务返回 `404`。

## 2. 配置示例

```yaml
users:
  - name: alice
    apiKey: piapi-user-alice
    services:
      codex:
        strategy: adaptive_rr   # round_robin / weighted_rr / adaptive_rr / sticky_healthy
        candidates:
          - providerName: provider-alpha
            providerKeyName: main-key
            weight: 3
            enabled: true
          - providerName: provider-beta
            providerKeyName: prod-key
            weight: 1
            enabled: true
      claude_code:
        providerName: provider-alpha   # 仍可使用旧版单路由写法
        providerKeyName: backup-key
```

候选字段说明：

| 字段 | 含义 |
| ---- | ---- |
| `providerName` / `providerKeyName` | 指向 `providers` 列表中的供应商与命名 Key |
| `weight` | 静态权重，适用于 `weighted_rr` / `adaptive_rr`；缺省或 `<=0` 时按 `1` 处理 |
| `enabled` | 是否参与调度；禁用后会在 UI 与运行时统计中标记为停用 |
| `tags` | 自定义标签（可选），目前用于在管理后台做分组或过滤 |

## 3. 调度策略

| 策略 | 行为 | 适用场景 |
| ---- | ---- | -------- |
| `round_robin` | 在健康候选之间轮流命中 | 默认均衡分流 |
| `weighted_rr` | 按静态权重分流 | 手动设定优先级 |
| `adaptive_rr` | 基于静态权重与平滑错误率共同决定有效权重 | 需要自动压制不稳定上游时 |
| `sticky_healthy` | 粘住最近成功的候选，失败或被禁用才切换 | 希望稳定命中质量最好的上游时 |

`adaptive_rr` 相关环境变量：

| 变量 | 默认值 | 说明 |
| ---- | ------ | ---- |
| `PIAPI_ADAPTIVE_HALFLIFE` | `1m` | 指标半衰期，决定错误率衰减速度 |
| `PIAPI_ADAPTIVE_QUALITY_FLOOR` | `0.1` | 质量下限，防止候选完全饿死 |

## 4. 运行时行为

1. `selectCandidate` 会先筛除禁用或处于 `unhealthyUntil` 的候选（失败后默认封禁 30s，502/503 封禁 60s）。
2. 针对 `adaptive_rr`，内部维护指数滑动窗口统计，计算 `smoothed_error_rate` 与 `effective_weight`。
3. `RuntimeStatus` API (`GET /piadmin/api/stats/routes`) 返回以下关键字段，便于在管理后台验证策略效果：
   - `healthy` / `unhealthy_until`
   - `total_requests` / `total_errors` / `error_rate`
   - `smoothed_error_rate` / `effective_weight`（仅对 `adaptive_rr` 有意义）
4. 当所有候选均不可用时，`Resolve` 返回 `ErrNoActiveUpstream`，网关向调用方返回 `503`。

## 5. 配置迁移提示

- 旧版仅包含 `providerName` 的配置仍然有效，但推荐逐步迁移到聚合写法，便于扩容或灰度。
- 若需将旧配置一次性转化为聚合模式，可保留原供应商作为首个候选，并将其它 Key 追加到 `candidates`。
- 更新配置后请观察管理后台的候选状态与错误率，确保策略按预期生效。
