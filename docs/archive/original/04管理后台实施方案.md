# 管理后台架构与实施指引

本文件描述 `/piadmin` 管理后台的系统架构、技术栈与日常开发流程，确保文档与当前实现保持一致。

## 1. 架构概览

- **入口与鉴权**：`/piadmin` 静态资源由 Go 网关内置的 `embed.FS` 提供；所有 `/piadmin/api/*` 请求需携带 `Authorization: Bearer <PIAPI_ADMIN_TOKEN>`。
- **后端组件**：`internal/adminapi` 负责配置读取与写入，写入路径包含原子落盘、失败回滚以及触发配置热加载；所有请求均输出结构化日志。
- **前端组件**：
  - 技术栈：Next.js 16、React 19、TypeScript、Tailwind CSS，依赖通过 `pnpm` 管理。
  - 基础路径：`basePath=/piadmin`，`next.config.mjs` 负责开发态代理 `/piadmin/api`。
  - 状态管理：SWR + `lib/api.ts`。`apiClient` 统一注入 Token，401 时自动清理并重定向到 `/piadmin/login`。
- **Observability**：管理后台的 Users 页面与 Observability 页面消费 `GET /piadmin/api/stats/routes`，展示候选健康、平滑错误率、有效权重等运行时指标。

## 2. 目录结构

```
docs/                                  # 项目文档
internal/adminapi/                     # Admin API Handler 与测试
web/admin/                             # Next.js 前端
  ├─ app/(admin)/*                     # Providers / Users / Observability 等页面
  ├─ components/                       # UI 组件（含 ServiceRouteCard 等）
  ├─ hooks/                            # SWR hooks（use-users、use-route-stats 等）
  └─ lib/api.ts                        # API 客户端封装
```

## 3. 开发流程

| 操作 | 命令 | 说明 |
| ---- | ---- | ---- |
| 启动后端（热重载） | `make dev-backend` | 使用 Air 监听 Go 源码，默认 `CONFIG=config.dev.yaml`，`PIAPI_ADMIN_TOKEN=piapi` |
| 启动前端 | `make dev-frontend` | 在 `web/admin` 下运行 `pnpm dev`，自动代理 `/piadmin/api` |
| 构建前端 | `pnpm install && pnpm build` | Next.js 生成 `.next` 产物，后续通过 `next export` 在 `make build` 中处理 |
| 构建统一二进制 | `make build` | 执行前端导出 + Go 编译，最终二进制自带静态资源 |
| 登录入口 | `http://localhost:3000/piadmin/login`（开发）/ `http://<host>:9200/piadmin/login`（生产） |

> 提示：开发态如需连接远端网关，可设置 `PIAPI_DEV_PROXY=http://<remote-host>:9200` 后再执行 `pnpm dev`。

## 4. 部署与集成

1. **环境变量**：必须设置 `PIAPI_ADMIN_TOKEN`；可选设置 `PIAPI_ADAPTIVE_HALFLIFE` / `PIAPI_ADAPTIVE_QUALITY_FLOOR` 调整路由质量算法。
2. **Docker 构建**：项目 Dockerfile 使用 Node + Go 多阶段；`make docker-build` 会先构建前端再发布 Go 二进制。
3. **静态资源服务**：Go 端在 `cmd/piapi/main.go` 将 `/piadmin/*` 先尝试返回静态文件，未命中则回退到 `index.html` 以支持前端路由。
4. **日志与审计**：所有 Admin API 调用会写入 `adminapi` 模块的结构化日志，字段包含 `request_id`、`operator`（来源于 token）等，可接入集中式日志。

## 5. 测试基线

- **后端**：`go test ./internal/adminapi ./internal/config ./internal/server`，重点覆盖配置写入、热加载与候选统计。
- **前端**：`pnpm lint`、`pnpm test`（如有）；建议对关键 hooks 与表单逻辑保留单测或视觉回归。
- **手工验收**：
  1. 登录/登出与 Token 错误提示；
  2. Providers 与 Users CRUD；
  3. 聚合路由保存后实际写入 `config.yaml` 并触发热加载；
  4. Observability 页面展示平滑错误率和有效权重；
  5. Docker 启动后可直接访问 `/piadmin`。

## 6. 维护建议

- 任何新增路由策略或监控指标，请同步更新 `lib/api.ts`、ServiceRouteCard、Observability 文档以及 `docs/05路由策略增强方案.md`。
- 若前端依赖升级涉及 Node 版本变更，应在 README 与 docs 中提示所需 Node 版本，并更新 CI 缓存。
- 定期检查构建产物大小与静态嵌入路径，确保 `make build` 和 `docker-build` 在 CI 中保持可重复。
