# 管理后台实施方案

## 目标概述

构建一个与现有 Go 网关深度集成的内部管理后台，实现配置的可视化查看与安全变更，最终形态为**单二进制**交付：Go 程序内嵌静态前端资源，通过 `/admin` 路径直接提供 UI 与 `/admin/api` 后端接口。

## 技术规范

- **后端**
  - `/admin/api` 路由由 `internal/adminapi` 提供，使用 `PIAPI_ADMIN_TOKEN` 作为 Bearer Token 鉴权。
  - 提供配置读取（原始 YAML + 结构化 JSON）与写入接口，写入流程需保持原子性、失败回滚，并在成功后触发热加载。
  - 所有管理请求记录结构化日志，后续可拓展审计信息。
- **前端**
  - 技术栈：Next.js 14、React 18、TypeScript、Tailwind CSS 3，依赖通过 `pnpm` 管理。
  - 目录：`web/admin/`，使用 `next export` 生成纯静态产物。
  - 代码规范：ESLint（Next + React + TypeScript）、Prettier、Tailwind class sorting；组件与 hooks 职责分离，使用 React Hook Form + Zod 做表单校验。
  - 状态管理：SWR 负责数据拉取与缓存，所有请求统一封装在 `lib/api.ts`，自动附带 `Authorization` 头。
  - 鉴权：登录页仅接收管理 Token，使用 `sessionStorage` 短期保存；登出清理 token 并跳转登录页。
- **集成**
  - 前端构建产物位于 `web/admin/out`，由 Go `embed.FS` 打包。
  - `/admin/*` 路由先尝试静态文件；若未命中则回退到 `index.html` 保持前端路由可用。
  - Makefile 与 Dockerfile 增加多阶段构建：Node 阶段构建前端，Go 阶段编译并包含静态资源。

## 实施阶段

1. **代码迁移与环境搭建**
   - 将 `tmp/` 原型迁至 `web/admin/`，初始化 `pnpm`、ESLint、Tailwind 配置，降级依赖到稳定版本。
   - 为前端添加 `.nvmrc`、`.npmrc` 或文档说明，统一 Node 版本（推荐 ≥ 20）。
2. **后端 API 完成度提升**
   - 根据需求补充必要的审计日志字段、错误码规范。
   - 设计配置写入的审计记录（至少 log out `request_id`、操作者、差异摘要）。
   - 视需要扩展结构化接口（如返回配置元数据、最近一次更新时间）。
3. **前端功能落地**
   - 重写 hooks，将 `GET /admin/api/config` 与 `PUT /admin/api/config/raw` 对接到布局与表格组件。
   - 为配置写入流程提供预览：基于结构化 JSON 构建表单后生成 YAML（或提示用户直接上传 YAML）。
   - 处理加载、错误、空态，使用 toast/alert 提示。
   - 完善登录/登出流程，确保 api token 统一注入并在 401 时自动跳转登录页。
4. **前后端集成 & 静态嵌入**
   - 在 Go 程序中通过 `//go:embed web/admin/out` 引入构建产物。
   - 扩展 `cmd/piapi/main.go`：增加静态文件路由、必要的缓存头设置（内部应用可默认关闭强缓存）。
   - 更新 Makefile：新增 `admin-install`, `admin-dev`, `admin-build`，将 `make build` 链接到前端构建。
   - Dockerfile 调整为 Node + Go 多阶段，最终镜像仅包含 Go 二进制与运行时依赖。
5. **测试与验收**
   - Go 侧：为 admin API 写入流程补充集成测试（已完成基础单测，后续可模拟并发与回滚）。
   - 前端：编写关键 hook 的单元测试、使用 Playwright 或 Cypress 进行基本流程回归。
   - 手工验收：验证登录、配置查看、配置保存失败回滚、成功热加载、嵌入资源加载、日志输出。
6. **文档与发布**
   - 更新 README “管理后台” 章节，补充开发、构建、部署说明。
  - 在 `docs/` 中扩写管理员操作流程、token 管理策略、回滚指引。
   - 调整发布清单，加入前端构建检查与静态资源嵌入验证。

## 风险与对策

- **配置写入风险**：任何写入失败必须回滚并返回明确错误信息；上线前准备多份示例 YAML 用于冒烟测试。
- **Token 泄露风险**：限制 token 存储，建议结合 VPN/IP 白名单；上线前在日志与监控中筛查是否有 token 泄漏。
- **构建复杂度**：Node + Go 多阶段构建增加 CI 时间，需要在流水线中缓存 `pnpm` 依赖。
- **静态导出限制**：Next.js export 不支持 SSR，开发时避免使用服务器组件或动态 API；必要时提前在文档中注明限制。

## 交付物

1. `internal/adminapi`：后端管理接口实现（已落地）。
2. `web/admin/` 前端代码与构建脚本。
3. 嵌入式静态资源服务（Go embed + 路由）。
4. Makefile、Dockerfile、README 与相关文档更新。
5. 测试报告（`go test ./...` + 前端测试）与手工验收记录。
