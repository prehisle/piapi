# 管理后台实施方案

## 目标概述

构建一个与现有 Go 网关深度集成的内部管理后台，实现配置的可视化查看与安全变更，最终形态为**单二进制**交付：Go 程序内嵌静态前端资源，通过 `/piadmin` 路径直接提供 UI，与 `/piadmin/api` 后端接口配合。

## 技术规范

- **后端**
  - `/piadmin/api` 路由由 `internal/adminapi` 提供，使用 `PIAPI_ADMIN_TOKEN` 作为 Bearer Token 鉴权。
  - 提供配置读取（原始 YAML + 结构化 JSON）与写入接口，写入流程需保持原子性、失败回滚，并在成功后触发热加载。
  - 所有管理请求记录结构化日志，后续可拓展审计信息。
- **前端**
  - 技术栈：Next.js 16、React 19、TypeScript、Tailwind CSS，依赖通过 `pnpm` 管理；构建方式为 `next export`。
  - 目录：`web/admin/`，路由以 `basePath=/piadmin` 暴露，开发态通过 `make dev-frontend` 启动，生产构建产物位于 `web/admin/out/`。
  - 状态管理：SWR 负责数据拉取与缓存，所有请求统一封装在 `lib/api.ts`，自动附带 `Authorization` 头并在 401 时清理 token。
  - 鉴权：登录页仅接收管理 Token，前端使用 `localStorage` 保存，登出与 401 统一跳转到 `/piadmin/login`。
- **集成**
  - 前端构建产物位于 `web/admin/out`，由 Go `embed.FS` 打包。
  - `/piadmin/*` 路由先尝试静态文件；若未命中则回退到 `index.html` 保持前端路由可用。
  - Makefile 提供 `admin-build`（静态构建）、`dev-frontend`（Next dev）、`dev-backend`（Air 热重载），Dockerfile 采用 Node + Go 多阶段构建。

## 本地开发与调试

| 操作 | 命令 | 说明 |
| ---- | ---- | ---- |
| 启动后端（热重载） | `make dev-backend` | 使用 Air 监听 Go 源码，默认使用 `CONFIG=config.dev.yaml`，TOKEN 默认值为 `piapi`。 |
| 启动前端（热重载） | `make dev-frontend` | 在 `web/admin` 目录执行 `pnpm dev`，自动将 `/api/*` 代理到 `http://localhost:9200/piadmin/api/*`。 |
| 生产构建 | `make build` | 依次执行 `admin-build` 与 Go 编译，产物内嵌静态资源。 |
| 登录入口 | `http://localhost:3000/piadmin/login` | 输入 `PIAPI_ADMIN_TOKEN` 即可访问 `/piadmin/providers`、`/piadmin/users`。 |

## 实施阶段

1. **代码迁移与环境搭建**
   - 将 `tmp/` 原型迁至 `web/admin/`，初始化 `pnpm`、ESLint、Tailwind 配置，降级依赖到稳定版本。
   - 为前端添加 `.nvmrc`、`.npmrc` 或文档说明，统一 Node 版本（推荐 ≥ 20）。
2. **后端 API 完成度提升**
   - 根据需求补充必要的审计日志字段、错误码规范。
   - 设计配置写入的审计记录（至少 log out `request_id`、操作者、差异摘要）。
   - 视需要扩展结构化接口（如返回配置元数据、最近一次更新时间）。
3. **前端功能落地**
   - 通过 SWR 拉取配置数据，`lib/api.ts` 统一封装 `GET /piadmin/api/config`、`PUT /piadmin/api/config/raw` 等接口。
   - Providers 页面支持校验型表单：API Key、服务类型、服务 URL 均需填写，错误时以红色边框与文案反馈。
   - Users 页面直接在列表内维护用户路由，逐项保存到后端配置，避免跳转。
   - 登录页使用 `apiClient` 校验 token，401 自动清理并重定向到 `/piadmin/login`。
4. **前后端集成 & 静态嵌入**
   - 在 Go 程序中通过 `//go:embed web/admin/out` 引入构建产物。
   - 扩展 `cmd/piapi/main.go`：增加静态文件路由、必要的缓存头设置（内部应用可默认关闭强缓存）。
   - 更新 Makefile：新增 `admin-install`, `admin-dev`, `admin-build`，将 `make build` 链接到前端构建。
   - Dockerfile 调整为 Node + Go 多阶段，最终镜像仅包含 Go 二进制与运行时依赖。
5. **测试与验收**
   - Go 侧：为 admin API 写入流程补充集成测试（已完成基础单测，后续可模拟并发与回滚）。
   - 前端：编写关键 hook 的单元测试、使用 Playwright 或 Cypress 进行基本流程回归。
   - 手工验收：验证登录、配置查看、配置保存失败回滚、成功热加载、嵌入资源加载、日志输出。
6. **文档与发布**
   - 更新 README “管理后台” 章节，补充开发、构建、部署说明。
  - 在 `docs/` 中扩写管理员操作流程、token 管理策略、回滚指引。
   - 调整发布清单，加入前端构建检查与静态资源嵌入验证。

## 风险与对策

- **配置写入风险**：任何写入失败必须回滚并返回明确错误信息；上线前准备多份示例 YAML 用于冒烟测试。
- **Token 泄露风险**：限制 token 存储，建议结合 VPN/IP 白名单；上线前在日志与监控中筛查是否有 token 泄漏。
- **构建复杂度**：Node + Go 多阶段构建增加 CI 时间，需要在流水线中缓存 `pnpm` 依赖。
- **静态导出限制**：Next.js export 不支持 SSR，开发时避免使用服务器组件或动态 API；必要时提前在文档中注明限制。

## 交付物

1. `internal/adminapi`：后端管理接口实现（已落地）。
2. `web/admin/` 前端代码与构建脚本。
3. 嵌入式静态资源服务（Go embed + 路由）。
4. Makefile、Dockerfile、README 与相关文档更新。
5. 测试报告（`go test ./...` + 前端测试）与手工验收记录。
